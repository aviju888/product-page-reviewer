<!doctype html>
<html>
<head>
  <title>Product Page Reviewer</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <h1>Product Page Reviewer</h1>
  <form id="form" method="post" action="/api/analyze">
    <input type="url" name="url" placeholder="https://example.com/product/123" required />
    <button type="submit" id="analyzeBtn">Analyze</button>
  </form>
  
  <div id="loading" style="display: none;">
    <div class="spinner"></div>
    <p>Analyzing page...</p>
  </div>
  
  <div id="dashboard" style="display: none;">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
      <!-- Heuristics Section -->
      <div class="dashboard-section">
        <h2>Page Analysis</h2>
        <div class="metrics-grid">
          <div class="metric-card">
            <h3>Page Title</h3>
            <p id="page-title">-</p>
          </div>
          <div class="metric-card">
            <h3>H1 Heading</h3>
            <p id="h1-heading">-</p>
          </div>
          <div class="metric-card">
            <h3>Price</h3>
            <p id="price">-</p>
          </div>
          <div class="metric-card">
            <h3>Call to Action</h3>
            <p id="cta">-</p>
          </div>
          <div class="metric-card">
            <h3>Images</h3>
            <p id="image-count">-</p>
          </div>
          <div class="metric-card">
            <h3>Missing Alt Text</h3>
            <p id="missing-alt">-</p>
          </div>
          <div class="metric-card">
            <h3>Testimonials</h3>
            <p id="testimonials">-</p>
          </div>
          <div class="metric-card">
            <h3>Security Badges</h3>
            <p id="security-badges">-</p>
          </div>
          <div class="metric-card">
            <h3>Forms</h3>
            <p id="form-count">-</p>
          </div>
          <div class="metric-card">
            <h3>Popups</h3>
            <p id="popup-count">-</p>
          </div>
          <div class="metric-card">
            <h3>H1-H6 Count</h3>
            <p id="headings">-</p>
          </div>
        </div>
      </div>

      <!-- LLM Analysis Section -->
      <div class="dashboard-section">
        <h2>AI Analysis</h2>
        <div class="analysis-content">
          <div class="analysis-card">
            <h3>Summary</h3>
            <p id="summary">-</p>
          </div>
          <div class="analysis-card">
            <h3>Top Findings</h3>
            <ul id="top-findings"></ul>
          </div>
        </div>
        <div style="margin-top: 10px;">
          <h3 style="margin: 0 0 8px 0; font-size: 14px; color: #2c3e50;">Recommended Actions</h3>
          <div id="actions"></div>
        </div>
      </div>
    </div>

    <!-- Raw Data Toggle -->
    <div class="dashboard-section" style="margin-top: 15px;">
      <button id="toggle-raw" class="toggle-btn">Show Raw Data</button>
      <pre id="raw-data" style="display: none;"></pre>
    </div>
  </div>

  <script>
    const form = document.getElementById("form");
    const dashboard = document.getElementById("dashboard");
    const loading = document.getElementById("loading");
    const analyzeBtn = document.getElementById("analyzeBtn");
    const toggleRawBtn = document.getElementById("toggle-raw");
    const rawData = document.getElementById("raw-data");
    
    let currentData = null;
    
    form.addEventListener("submit", async e => {
      e.preventDefault();
      
      // Show loading state
      loading.style.display = "block";
      dashboard.style.display = "none";
      analyzeBtn.disabled = true;
      analyzeBtn.textContent = "Analyzing...";
      
      try {
        const url = form.url.value;
        const res = await fetch("/api/analyze", { 
          method: "POST", 
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url: url })
        });
        
        const data = await res.json();
        currentData = data;
        populateDashboard(data);
        dashboard.style.display = "block";
      } catch (error) {
        alert(`Error: ${error.message}`);
      } finally {
        // Hide loading state
        loading.style.display = "none";
        analyzeBtn.disabled = false;
        analyzeBtn.textContent = "Analyze";
      }
    });

    toggleRawBtn.addEventListener("click", () => {
      if (rawData.style.display === "none") {
        rawData.style.display = "block";
        rawData.textContent = JSON.stringify(currentData, null, 2);
        toggleRawBtn.textContent = "Hide Raw Data";
      } else {
        rawData.style.display = "none";
        toggleRawBtn.textContent = "Show Raw Data";
      }
    });

    function populateDashboard(data) {
      // Populate heuristics
      document.getElementById("page-title").textContent = data.heuristics.title || "Not found";
      document.getElementById("h1-heading").textContent = data.heuristics.h1 || "Not found";
      document.getElementById("price").textContent = data.heuristics.price || "Not found";
      document.getElementById("cta").textContent = data.heuristics.cta || "Not found";
      document.getElementById("image-count").textContent = data.heuristics.image_count || "0";
      document.getElementById("missing-alt").textContent = data.heuristics.images_missing_alt || "0";
      document.getElementById("testimonials").textContent = data.heuristics.testimonials || "0";
      document.getElementById("security-badges").textContent = data.heuristics.security_badges || "0";
      document.getElementById("form-count").textContent = data.heuristics.form_count || "0";
      document.getElementById("popup-count").textContent = data.heuristics.popup_count || "0";
      
      // Format headings display
      const headings = data.heuristics.headings || {};
      const headingText = Object.entries(headings)
        .map(([key, value]) => `${key}: ${value}`)
        .join(", ");
      document.getElementById("headings").textContent = headingText || "0";

      // Populate LLM analysis if available
      if (data.llm_report && data.llm_report !== "LLM not configured") {
        try {
          const llmData = JSON.parse(data.llm_report);
          
          document.getElementById("summary").textContent = llmData.summary || "No summary available";
          
          const findingsList = document.getElementById("top-findings");
          findingsList.innerHTML = "";
          if (llmData.top_findings && Array.isArray(llmData.top_findings)) {
            llmData.top_findings.forEach(finding => {
              const li = document.createElement("li");
              li.textContent = finding;
              findingsList.appendChild(li);
            });
          }

          const actionsDiv = document.getElementById("actions");
          actionsDiv.innerHTML = "";
          if (llmData.actions && Array.isArray(llmData.actions)) {
            llmData.actions.forEach(action => {
              const actionCard = document.createElement("div");
              actionCard.className = "action-item";
              actionCard.innerHTML = `
                <h4>${action.action || "Action"}</h4>
                <p><strong>Why:</strong> ${action.why || "No explanation provided"}</p>
                <p><strong>Impact:</strong> ${action.impact || "Not specified"}</p>
                <p><strong>Effort:</strong> ${action.effort || "Not specified"}</p>
              `;
              actionsDiv.appendChild(actionCard);
            });
          }
        } catch (e) {
          document.getElementById("summary").textContent = "Error parsing LLM analysis";
          console.error("Error parsing LLM data:", e);
        }
      } else {
        document.getElementById("summary").textContent = "LLM analysis not available";
      }
    }
  </script>
</body>
</html>